<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
   <!-- Bootstrap CSS -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet"
   integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
<!-- D3.js -->
<script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-sm-6">
                <div id="chart" class="col"></div>
                <select id="selectButton"></select>
            </div>
            <div class="col-sm-6">

            </div>
        </div>
    </div>

    <!-- Create a div where the graph will take place -->
    <div id=""></div>
 <!-- Initialize a select button -->
 
    <script>
        // set the dimensions and margins of the graph
        const margin = {
            top: 10,
            right: 30,
            bottom: 50,
            left: 80
        };
        const chartContainer = d3.select("#chart");
        const width = chartContainer.node().clientWidth - margin.left - margin.right;
        const height = width * 0.6; // Set the height to be 60% of the width

        const svg = chartContainer
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // append the svg object to the body of the page


        // Read the mean and standard deviation data
        Promise.all([
            d3.csv("Results/combined_summary_grouped_mean.csv"),
            d3.csv("Results/combined_summary_grouped_std.csv")
        ]).then(function ([meanData, stdData]) {

            // List of groups
            const allGroup = ["SF_12_10", "SF_12_20", "SF_12_30", "SF_12_40", "SF_12_50", "SF_12_60",
                "SF_12_70", "SF_12_80", "SF_12_90", "SF_12_100", "SF_12_110", "SF_12_120", "SF_12_130"
            ];
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

            // Create a dictionary (object) where each group is assigned a color
            const groupColors = {};
            allGroup.forEach(group => {
                groupColors[group] = colorScale(group);
            });
            // Add the options to the button
            d3.select("#selectButton")
                .selectAll('myOptions')
                .data(allGroup)
                .enter()
                .append('option')
                .text(d => d) // text showed in the menu
                .attr("value", d => d); // corresponding value returned by the button

            // Add X axis --> it is a date format
            const x = d3.scaleLinear()
                .domain([2020, 2036])
                .range([0, width]);
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            // Add Y axis
            const y = d3.scaleLinear()
                .domain([0, 3.0])
                .range([height, 0]);
            svg.append("g")
                .call(d3.axisLeft(y));

            // Initialize line with group a
            const line = svg
                .append('g')
                .append("path")
                .datum(meanData)
                .attr("d", d3.line()
                    .x(d => x(+d.year))
                    .y(d => y(+d.SF_12_10))
                )
                .attr("stroke", groupColors["SF_12_10"])
                .style("stroke-width", 1)
                .style("fill", "none");

            // Initialize area for standard deviation
            const area = svg
                .append('g')
                .append("path")
                .attr("class", "area")
                .style("fill", groupColors["SF_12_10"])
                .style("opacity", 0.2);

            // Initialize dots with group a
            const dot = svg
                .selectAll('circle')
                .data(meanData)
                .join('circle')
                .attr("cx", d => x(+d.year))
                .attr("cy", d => y(+d.SF_12_10))
                .attr("r", 5)
                .style("fill", groupColors["SF_12_10"]);

            // A function that updates the chart
            function update(selectedGroup) {
                // Create new data with the selection
                const dataFilter = meanData.map(function (d) {
                    return {
                        year: d.year,
                        value: d[selectedGroup],
                        std: stdData.find(sd => sd.year === d.year)[selectedGroup]
                    };
                });

                const stdFilter = stdData.map(function (d) {
                    return {
                        year: d.year,
                        value: d[selectedGroup],
                        std: stdData.find(sd => sd.year === d.year)[selectedGroup]
                    };
                }); // Update the line
                line
                    .datum(dataFilter)
                    .transition()
                    .duration(500)
                    .attr("d", d3.line()
                        .x(d => x(+d.year))
                        .y(d => y(+d.value))
                    )
                    .style("stroke", groupColors[selectedGroup]);

                // Update the area
                area
                    .datum(stdFilter)
                    .transition()
                    .duration(500)
                    .attr("d", d3.area()
                        .x(d => x(+d.year))
                        .y0(d => y(+d.value - d.std)) // Lower bound (mean - std)
                        .y1(d => y(+d.value + d.std)) // Upper bound (mean + std)
                    )
                    .style("fill", groupColors[selectedGroup]);

                // Update the dots
                dot
                    .data(dataFilter)
                    .transition()
                    .duration(500)
                    .attr("cx", d => x(+d.year))
                    .attr("cy", d => y(+d.value))
                    .style("fill", groupColors[selectedGroup]);
            }

            // When the button is changed, run the updateChart function
            d3.select("#selectButton").on("change", function (event, d) {
                // recover the option that has been chosen
                let selectedOption = d3.select(this).property("value");
                // run the updateChart function with this selected option
                update(selectedOption);
            });

        });
    </script>
</body>

</html>